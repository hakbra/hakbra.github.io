<html>
    <head>
        <style>
            select {width: 300;}

            #selectors {
            }

            #selectedUsers {
            }

            #input {
            }
            
            #chart-container {
                width: 400px;
                height:400px;
                float: left;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
        <script type="text/javascript">
            var apiGetUsers = "https://turotrackerfetcher.azurewebsites.net/api/users?code=W0cY9erJuRhGLxSra7jDufItw6SRNnkPaHCw7pzmnLrRO9xa2Uln2w==";
            var apiGetClubs = "https://turotrackerfetcher.azurewebsites.net/api/clubs?code=15OpgjQl5HA4uYALGRZxvc7peWwBIjdHe32wJtD3ASRkgAiFRzKqfA==";
            
            var selectedUserIDs = [];
            var selectedClub = 0;

            var users = {};
            var clubs = {};

            var data = {};
            var mode = 1;
            var loaded = false;

            var graph = null;

            var urlParams = null;

            function urlParamsUpdated()
            {
                if (urlParams == null)
                {
                    return;
                }

                var loc = window.location;
                var url = `${loc.origin}${loc.pathname}?${urlParams.toString()}`
                console.log(url)
                history.replaceState(null, '', url);
            }

            function parseUrl()
            {
                if (!loaded)
                {
                    console.log("data not loaded")
                    loaded = true;
                    return;
                }

                console.log("parsing url")

                var queryString = window.location.search;
                urlParams = new URLSearchParams(queryString);

                if (urlParams.has('mode'))
                {
                    mode = urlParams.get('mode');
                    console.log("Found mode " + mode)
                }

                if (urlParams.has('club'))
                {
                    selectClub(urlParams.get('club'))
                    console.log("Found club " + selectedClub)
                }
                
                if (urlParams.has('users'))
                {
                    var userIDs = urlParams.get('users').split(',');
                    console.log("Found users " + userIDs);
                    userIDs.forEach( (userID, index) => selectUser(userID));
                }
            }

            $(document).ready( function() {
              $.get(apiGetUsers, function ( data ) {
                data.forEach( (user, index) => users[user.userID] = user);
                $.each(data, function(i, p) {
                    $('#selectUser').append($('<option></option>').val(p.userID).html(p.name));
                });

                parseUrl();
              });
              
              $.get(apiGetClubs, function ( data ) {
                data.forEach( (club, index) => clubs[club.clubID] = club);
                clubs[0] = {clubID: 0, name: "Total"}
                $.each(data, function(i, p) {
                    $('#selectClub').append($('<option></option>').val(p.clubID).html(p.name));
                });

                parseUrl();
              });
            });

            function clubSelected(selector) {
                var clubID = parseInt(selector.options[selector.selectedIndex].value);
                if  (clubID  == -1)
                {
                    selector.selectedIndex = 0;
                    return;
                }

                selectClub(clubID);
                urlParams.set("club", clubID);
                urlParamsUpdated();
            }

            function selectClub(clubID) {
                if  (clubID == selectedClub)
                {
                    return;
                }

                $('#selectClub')[0].value = clubID;
                selectedClub = clubID;
                userData = {}
                selectedUserIDs.forEach( (userID, index) => getDataForUser(userID));
            }
            

            function userSelected(selector) {
                var userID = parseInt(selector.options[selector.selectedIndex].value);
                if  (userID  == -1)
                {
                    selector.selectedIndex = 0;
                    return;
                }
                
                selectUser(userID);
            }

            function selectUser(userID)
            {
                $('#selectUser')[0].selectedIndex = 0;
                var index = selectedUserIDs.indexOf(userID);
                if (index != -1)
                {
                    return;
                }

                selectedUserIDs.push(userID);

                var name = users[userID].name;
                $('#selectedUsers').append($('<div></div>').attr("UserID",userID).attr("onclick","removeUser(this)").html(name));

                getDataForUser(userID);
                urlParams.set("users", selectedUserIDs.join(','));
                urlParamsUpdated();
            }

            function modeSelected(selector) {
                var newMode = parseInt(selector.options[selector.selectedIndex].value);
                if  (newMode == mode)
                {
                    return;
                }
                
                mode = newMode;
                dataUpdated();
                urlParams.set("mode", mode);
                urlParamsUpdated();
            }

            function getDataForUser(userID)
            {
                if  (selectedClub == null)
                {
                    return;
                }

                console.log(`Getting data for user [${userID}] in club [${selectedClub}]`)
                var url = `https://turotrackerfetcher.azurewebsites.net/api/scores/${selectedClub}/${userID}?code=D2DC7NmU0RuGdoKvH6VFfDAaPDkM5Zy9SxXyNZkOoP8uQfoJ8/6wKA==`

                $.get(url, function ( userData ) {
                    data[userID] = userData;
                    dataUpdated();
                });
            }

            function removeUser(userItem) {
                var userID = parseInt($(userItem).attr("userid"));
                
                var index = selectedUserIDs.indexOf(userID);
                if (index != -1)
                {
                    selectedUserIDs.splice(index, 1);
                }

                userItem.remove();
                delete data[userID];
                dataUpdated();
            }

            function dataUpdated()
            {
                if  (selectedClub == null)
                {
                    return;
                }
                
                var datasets = [];
                for (var key in data)
                {
                    var userData = data[key];
                    var userValues;
                    if (mode == 4) { userValues = userData.map(ud => {return {x: ud.date, y: ud.rankPunches}} ) }
                    else if (mode == 3) { userValues = userData.map(ud => {return {x: ud.date, y: ud.rankPoints}}) }
                    else if (mode == 2) { userValues = userData.map(ud => {return {x: ud.date, y: ud.punches}}) }
                    else { userValues = userData.map(ud => {return {x: moment(ud.date), y: ud.points}}) }

                    var dataset = {
                            label: users[key].name,
                            data : userValues
                    };

                    console.log(dataset);
                    datasets.push(dataset);
                }

                var ctx = document.getElementById('graph').getContext('2d');
                if (graph != null)
                {
                    graph.destroy();
                }

                graph = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: false,
                        scales: {
                            xAxes: [{
                                type: 'time'
                            }],
                            yAxes: [{
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });
            }
        </script>
    </head>
    <body>
        <div id="input">
            <div id="selectors">
                <div id="selectClubDiv">
                    <select id="selectClub" onchange="clubSelected(this)">
                        <option Value="0">Total</option>
                        <option Value="-1">-----------</option>
                    </select>
                </div>

                <div id="selectUserDiv">
                    <select id="selectUser" onchange="userSelected(this)">
                        <option Value="-1">Select Users</option>
                        <option Value="-1">------------</option>
                    </select>
                </div>
                
                <div id="selectModeDiv">
                    <select id="selectMode" onchange="modeSelected(this)">
                        <option Value="1">Score</option>
                        <option Value="2">Punches</option>
                        <option Value="3">Rank - Score</option>
                        <option Value="4">Rank - Punches</option>
                    </select>
                </div>
            </div>

            <div id="selectedUsers">
                Selected Users:
            </div>
        </div>
        
        <div id="chartContainer" width="400" height="400">
            <canvas id="graph"></canvas>
        </div>
    </body>
</html>